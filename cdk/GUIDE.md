# InteGreat CDK Production Guide 🏗️

This guide explains how to use the AWS Cloud Development Kit (CDK) for deploying InteGreat platform to production environments.

## Overview 📋

This repository contains the production infrastructure code for the InteGreat platform using AWS CDK. It provisions and manages all AWS resources required for production deployments through infrastructure as code (IaC).

## Getting Started 🚀

### Prerequisites

- Node.js (v18 or later)
- AWS Account with administrative permissions
- AWS CDK CLI (v2.x)
- AWS CLI configured with appropriate credentials
- Firebase projects created for each tenant application

### Installation 📥

```bash
# Install AWS CDK CLI globally if not already installed
npm install -g aws-cdk

# Install project dependencies
npm install
```

### Configuration ⚙️

```bash
# Configure AWS profile for CDK (if not using default)
export AWS_PROFILE=integreat-admin

# Create and configure .env file in root with necessary environment variables
AWS_REGION=ap-southeast-1

COGNITO_USER_POOL_NAME=InteGreatUserPool
NEON_DB_CONNECTION_STRING_CHURCH=your_church_db_connection_string
NEON_DB_CONNECTION_STRING_EVENTS=your_events_db_connection_string
NEON_DB_CONNECTION_STRING_STUDENT=your_student_db_connection_string
PHIL_SMS_API_URL=https://app.philsms.com/api/v3
PHIL_SMS_API_KEY=your_phil_sms_api_key
SES_SENDER_EMAIL=integreatapi@gmail.com
SUPABASE_URL=your_supabase_url
SUPABASE_KEY=your_supabase_key
# NOTE: Sensitive information should be stored in AWS Parameter Store
# List of tenant project IDs for multi-tenant deployment
TENANT_IDS=evntgarde-event-management,pillars-edu-quality-assessor,teleo-church-application,campus-student-lifecycle

```

### Firebase OIDC Provider Setup 🔑

Before deploying CDK stacks, you must create an OIDC provider in AWS IAM for each Firebase project:

```bash
# For each Firebase project, create an OIDC provider
aws iam create-open-id-connect-provider \
  --url https://securetoken.google.com/YOUR_FIREBASE_PROJECT_ID \
  --client-id-list sts.amazonaws.com \
  --thumbprint-list "a031c46782e6e6c662c2c87c76da9aa62ccabd8e"
```

> **Note**: The thumbprint is for Google's issuer. Verify it's current by checking Google's documentation.

### CDK Initialization 🔧

For first-time setup in a new AWS environment:

```bash
# Bootstrap CDK in your AWS account/region
cdk bootstrap aws://ACCOUNT-NUMBER/REGION

# Synthesize CloudFormation templates to see what will be deployed
cdk synth
```

### Deployment 🚢

```bash
# Build TypeScript files to JavaScript
npm run build

# Deploy all stacks to production
cdk deploy --all

# Deploy only specific tenant stacks
cdk deploy "evntgarde-event-management-*"

# Deploy with approval disabled for CI/CD pipelines
cdk deploy --all --require-approval never
```

### Monitoring & Testing 👀

```bash
# Check status of deployed stacks
cdk list

# Test API endpoints locally with SAM CLI
sam local start-api
```

## CDK Project Structure 📁

```
/cdk
├── .aws-sam/               # Local testing artifacts for AWS SAM CLI
├── bin/
│   ├── cdk.ts              # Entry point for the CDK application
├── dist/                   # Compiled JavaScript files (generated during build)
├── lib/
│   ├── auth-stack.ts       # Creates Cognito Identity Pools connected to Firebase
│   ├── storage-stack.ts    # Provisions tenant-isolated S3 buckets with CORS
│   ├── iam-stack.ts        # Sets up IAM roles with tenant-specific permissions
│   ├── api-stack.ts        # Sets up API Gateway and Lambda integrations
│   ├── db-stack.ts         # Configures database integration
│   ├── monitoring-stack.ts # Configures monitoring and alarms
├── functions/
│   ├── index.ts            # Main export file for all Lambda handlers
│   ├── handlers/           # Lambda handlers organized by domain
├── shared/
│   ├── services/           # Business logic used by multiple handlers
│   ├── config/             # Configuration files
│   ├── types/              # Type definitions
│   ├── utils/              # Shared utilities like logging
```


## Build Process and Directory Structure 🔄

### Source Code (`lib/` and `functions/`)
- Contains TypeScript source files
- These are the files you edit and commit to version control
- Organized by functionality and domain

### Compiled Code (`dist/`)
- Generated during the build process (`npm run build`)
- Contains JavaScript files compiled from TypeScript
- Not committed to version control (included in .gitignore)
- Used for deployment and local testing

### Local Testing Artifacts (`.aws-sam/`)
- Generated by AWS SAM CLI during local testing
- Contains temporary build artifacts and test configurations
- Not committed to version control (included in .gitignore)
- Used for `sam local start-api` and other local testing commands

### Build Workflow
1. Write and modify TypeScript code in `lib/` and `functions/`
2. Run `npm run build` to compile to JavaScript
3. Compiled files appear in `dist/`
4. For local testing:
   - Run `sam local start-api` to test API endpoints
   - This generates `.aws-sam/` directory
5. Deploy using `cdk deploy`

## Infrastructure Architecture 🏢
=======
## Multi-Tenant Architecture 🏢


InteGreat implements a strong multi-tenant separation with complete isolation between tenants. Each tenant gets its own set of AWS resources:

```
Firebase Project A                    AWS Account (InteGreat)
┌──────────────────┐                 ┌───────────────────────────────┐
│  Authentication  │                 │        AuthStack A            │
│  Firestore       │                 │  ┌─────────────────────────┐  │
│  Hosting         │ ──── OIDC ────► │  │ Cognito Identity Pool A │  │
└──────────────────┘                 │  └─────────────────────────┘  │
                                     │                               │
                                     │        StorageStack A         │
                                     │  ┌─────────────────────────┐  │
                                     │  │     S3 Bucket A         │  │
                                     │  │  (with CORS enabled)    │  │
                                     │  └─────────────────────────┘  │
                                     │                               │
Firebase Project B                   │        IamStack A             │
┌──────────────────┐                 │  ┌─────────────────────────┐  │
│  Authentication  │                 │  │   TenantUserRole A      │  │
│  Firestore       │                 │  └─────────────────────────┘  │
│  Hosting         │ ──── OIDC ────► │                               │
└──────────────────┘                 │        AuthStack B            │
                                     │  ┌─────────────────────────┐  │
                                     │  │ Cognito Identity Pool B │  │
                                     │  └─────────────────────────┘  │
                                     │                               │
                                     │        StorageStack B         │
                                     │  ┌─────────────────────────┐  │
                                     │  │     S3 Bucket B         │  │
                                     │  │  (with CORS enabled)    │  │
                                     │  └─────────────────────────┘  │
                                     │                               │
                                     │        IamStack B             │
                                     │  ┌─────────────────────────┐  │
                                     │  │   TenantUserRole B      │  │
                                     │  └─────────────────────────┘  │
                                     └───────────────────────────────┘
```

### Key Components:

1. **Tenant Identification**: Each application is identified by its Firebase project ID
2. **AuthStack**: Creates a dedicated Cognito Identity Pool that trusts only that tenant's Firebase OIDC provider
3. **StorageStack**: Creates a tenant-specific S3 bucket with appropriate CORS configuration
4. **IamStack**: Sets up IAM roles specific to each tenant with proper permissions

### Authentication Flow:

1. User signs in to the tenant application using Firebase Auth
2. Frontend obtains Firebase JWT token
3. JWT token is passed to AWS Cognito Identity Pool via AWS SDK
4. Cognito validates the token and issues temporary AWS credentials
5. AWS SDK uses these credentials to access S3 directly from the browser

## Infrastructure Architecture 🏙️

### Authentication 🔐

- **Firebase Authentication** serves as the primary identity provider for each tenant
- **AWS Cognito Identity Pools** are configured as OIDC identity providers
- Each Identity Pool is bound to a specific Firebase project
- IAM roles restrict access to tenant-specific resources

### Storage 📦

- Each tenant gets its own isolated S3 bucket
- Buckets follow a naming pattern `<project-id>-tenant-bucket`
- All public access is blocked for security
- CORS is configured to allow direct browser access via the AWS SDK
- Lifecycle policies can be added for cost optimization

### API Gateway 🌉

- For complex operations beyond direct S3 access, a shared API Gateway can be configured
- Routes are organized by domain and protected by appropriate authorization
- Lambda functions handle business logic and additional processing

## Common Operations 🔄

### Adding a New Tenant

To add a new tenant to the infrastructure:

1. Create a new Firebase project for the tenant
2. Configure the Firebase project with proper authentication settings
3. Create an OIDC provider in AWS IAM for the Firebase project
4. Add the tenant's Firebase project ID to the `tenants` array in `cdk/bin/cdk.ts`
5. Deploy the infrastructure with `cdk deploy --all`

### Updating CORS Settings

When you're ready to lock down CORS to specific domains:

1. Update `storage-stack.ts` to replace the wildcard `*` with your specific domains:
```typescript
allowedOrigins: ['https://yourdomain.com', 'https://www.yourdomain.com'],
```
2. Deploy the updated stack with `cdk deploy "*-storage"`

### Handling Infrastructure Changes

1. Make changes to appropriate CDK stack files
2. Run `npm run build` to compile changes
3. Run `cdk diff` to see what will change
4. Run `cdk deploy` to apply changes

### Destroying Infrastructure (Development Only)

```bash
# WARNING: Only use in development environments!
cdk destroy --all

# To destroy specific tenant stacks
cdk destroy "evntgarde-event-management-*"
```

## Useful Commands 🛠️

Here are some common commands you'll use during CDK development:

```bash
# Compile TypeScript to JavaScript (generates dist/ directory)
npm run build

# Watch for changes and compile automatically
npm run watch

# Perform Jest unit tests
npm run test

# Deploy stack to your default AWS account/region
npx cdk deploy

# Compare deployed stack with current state
npx cdk diff

# Emit the synthesized CloudFormation template
npx cdk synth
```

## Frontend Integration 🌐

To integrate the frontend application with the AWS resources:

```typescript
// Example React hook for AWS authentication with Firebase
import { useState, useEffect } from 'react';
import firebase from 'firebase/app';
import 'firebase/auth';
import AWS from 'aws-sdk/global';

// Your tenant's Firebase project ID
const projectId = 'evntgarde-event-management';

export function useAwsAuth() {
  const [credentials, setCredentials] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  useEffect(() => {
    const setupAwsCredentials = async () => {
      try {
        // Get the current Firebase user
        const currentUser = firebase.auth().currentUser;
        
        if (!currentUser) {
          setLoading(false);
          return;
        }
        
        // Get a fresh Firebase ID token
        const idToken = await currentUser.getIdToken();
        
        // Configure AWS credentials
        AWS.config.region = 'ap-southeast-1'; // Your AWS region
        const credentials = new AWS.CognitoIdentityCredentials({
          Logins: {
            [`securetoken.google.com/${projectId}`]: idToken
          },
          IdentityPoolId: `ap-southeast-1:${projectId}-identity-pool`
        });
        
        // Refresh the credentials
        await credentials.getPromise();
        
        setCredentials(credentials);
        setLoading(false);
      } catch (err) {
        setError(err);
        setLoading(false);
      }
    };
    
    setupAwsCredentials();
  }, []);
  
  return { credentials, loading, error };
}
```

Example S3 upload with these credentials:

```typescript
import AWS from 'aws-sdk';
import { useAwsAuth } from './useAwsAuth';

function FileUploader() {
  const { credentials, loading, error } = useAwsAuth();
  
  const uploadFile = async (file) => {
    if (!credentials) return;
    
    // Create S3 service object with temporary credentials
    const s3 = new AWS.S3({
      credentials: credentials
    });
    
    const params = {
      Bucket: 'evntgarde-event-management-tenant-bucket',
      Key: `uploads/${file.name}`,
      Body: file,
      ContentType: file.type
    };
    
    try {
      const result = await s3.upload(params).promise();
      console.log('Successfully uploaded file:', result);
      return result.Location;
    } catch (err) {
      console.error('Error uploading file:', err);
      throw err;
    }
  };
  
  // Component implementation...
}
```

## Best Practices 📝

1. **Infrastructure as Code**: Always modify infrastructure through CDK, never manually in the AWS console

2. **Least Privilege**: Follow principle of least privilege when defining IAM roles
3. **Parameterize**: Use CDK context variables and AWS Parameter Store for environment-specific values
4. **Version Control**: Commit CDK changes with descriptive messages explaining the infrastructure changes
5. **Testing**: Test infrastructure changes in development before applying to production
6. **Build Process**: Always run `npm run build` before deploying to ensure latest changes are compiled
7. **Generated Files**: Never commit files from the `dist/` directory to version control
8. **Tenant Isolation**: Maintain strict separation between tenants' resources
9. **Least Privilege**: Follow principle of least privilege when defining IAM roles
10. **Parameterize**: Use CDK context variables and AWS Parameter Store for environment-specific values
11. **Version Control**: Commit CDK changes with descriptive messages explaining the infrastructure changes
12. **Security**: Always use HTTPS and configure CORS to restrict access to trusted domains in production


## Troubleshooting 🔍

- **CloudFormation Errors**: Check CloudFormation in the AWS Console for detailed error messages

- **CDK Synth Issues**: Ensure TypeScript code compiles correctly with `npm run build`
- **Permission Problems**: Verify IAM permissions for the deploying user
- **API Gateway Errors**: Check CloudWatch Logs for Lambda function errors
- **Build Issues**: If `dist/` files are missing or outdated, run `npm run build` to regenerate them

## API Endpoints for Testing 🌐

### Email Notification Endpoint
```bash
# Send email notification
POST https://api-gateway-url.amazonaws.com/prod/email/send
Content-Type: application/json

{
  "eventId": "your-event-id",
  "recipientEmail": "recipient@example.com"
}
```

### SMS Notification Endpoint
```bash
# Send SMS notification
POST https://api-gateway-url.amazonaws.com/prod/sms/send
Content-Type: application/json

{
  "eventId": "your-event-id",
  "recipientPhone": "+639123456789"
}
```

### Local Testing with SAM CLI
```bash
# Start local API server
sam local start-api

### Email Notification Endpoint
```bash
# Send email notification
POST http://127.0.0.1:3000/email/send
Content-Type: application/json

{
  "eventId": "your-event-id",
  "recipientEmail": "recipient@example.com"
}
```

### SMS Notification Endpoint
```bash
# Send SMS notification
POST http://127.0.0.1:3000/sms/send
Content-Type: application/json

{
  "eventId": "your-event-id",
  "recipientPhone": "+639123456789"
}
```
=======
- **CORS Issues**: Verify that your S3 bucket CORS configuration allows requests from your frontend domain
- **Authentication Problems**: Check Firebase configuration and ensure the OIDC provider is correctly set up
- **Permission Denied Errors**: Verify IAM roles have the correct permissions for the required actions

