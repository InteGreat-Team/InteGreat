# InteGreat CDK Production Guide ğŸ—ï¸

This guide explains how to use the AWS Cloud Development Kit (CDK) for deploying InteGreat platform to production environments.

## Overview ğŸ“‹

This repository contains the production infrastructure code for the InteGreat platform using AWS CDK. It provisions and manages all AWS resources required for production deployments through infrastructure as code (IaC).

## Getting Started ğŸš€

### Prerequisites

- Node.js (v18 or later)
- AWS Account with administrative permissions
- AWS CDK CLI (v2.x)
- AWS CLI configured with appropriate credentials

### Installation ğŸ“¥

```bash
# Install AWS CDK CLI globally if not already installed
npm install -g aws-cdk

# Install project dependencies
npm install
```

### Configuration âš™ï¸

```bash
# Configure AWS profile for CDK (if not using default)
export AWS_PROFILE=integreat-admin

# Create and configure .env file in root with necessary environment variables
AWS_REGION=ap-southeast-1
COGNITO_USER_POOL_NAME=InteGreatUserPool
NEON_DB_CONNECTION_STRING_CHURCH=your_church_db_connection_string
NEON_DB_CONNECTION_STRING_EVENTS=your_events_db_connection_string
NEON_DB_CONNECTION_STRING_STUDENT=your_student_db_connection_string
PHIL_SMS_API_URL=https://app.philsms.com/api/v3
PHIL_SMS_API_KEY=your_phil_sms_api_key
SES_SENDER_EMAIL=integreatapi@gmail.com
SUPABASE_URL=your_supabase_url
SUPABASE_KEY=your_supabase_key
# NOTE: Sensitive information should be stored in AWS Parameter Store
```

### CDK Initialization ğŸ”§

For first-time setup in a new AWS environment:

```bash
# Bootstrap CDK in your AWS account/region
cdk bootstrap aws://ACCOUNT-NUMBER/REGION

# Synthesize CloudFormation templates to see what will be deployed
cdk synth
```

### Deployment ğŸš¢

```bash
# Build TypeScript files to JavaScript
npm run build

# Deploy all stacks to production
cdk deploy --all

# Deploy specific stacks only
cdk deploy AuthStack ApiStack StorageStack

# Deploy with approval disabled for CI/CD pipelines
cdk deploy --all --require-approval never
```

### Monitoring & Testing ğŸ‘€

```bash
# Check status of deployed stacks
cdk list

# Test API endpoints locally with SAM CLI
sam local start-api
```

## CDK Project Structure ğŸ“

```
/cdk
â”œâ”€â”€ .aws-sam/               # Local testing artifacts for AWS SAM CLI
â”œâ”€â”€ bin/
â”‚   â”œâ”€â”€ cdk.ts              # Entry point for the CDK application
â”œâ”€â”€ dist/                   # Compiled JavaScript files (generated during build)
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ auth-stack.ts       # Defines AWS Cognito configuration for authentication
â”‚   â”œâ”€â”€ api-stack.ts        # Sets up API Gateway and Lambda integrations
â”‚   â”œâ”€â”€ storage-stack.ts    # Provisions S3 buckets for storage
â”‚   â”œâ”€â”€ iam-stack.ts        # Manages IAM Roles and policies
â”‚   â”œâ”€â”€ db-stack.ts         # Provisions and configures database integration
â”‚   â”œâ”€â”€ monitoring-stack.ts # Configures monitoring and alarms (e.g., CloudWatch)
â”œâ”€â”€ functions/
â”‚   â”œâ”€â”€ index.ts            # Main export file for all Lambda handlers
â”‚   â”œâ”€â”€ handlers/           # Lambda handlers organized by domain
â”œâ”€â”€ shared/
â”‚   â”œâ”€â”€ services/           # Business logic used by multiple handlers
â”‚   â”œâ”€â”€ config/             # Configuration files
â”‚   â”œâ”€â”€ types/              # Type definitions
â”‚   â”œâ”€â”€ utils/              # Shared utilities like logging
```

## Build Process and Directory Structure ğŸ”„

### Source Code (`lib/` and `functions/`)
- Contains TypeScript source files
- These are the files you edit and commit to version control
- Organized by functionality and domain

### Compiled Code (`dist/`)
- Generated during the build process (`npm run build`)
- Contains JavaScript files compiled from TypeScript
- Not committed to version control (included in .gitignore)
- Used for deployment and local testing

### Local Testing Artifacts (`.aws-sam/`)
- Generated by AWS SAM CLI during local testing
- Contains temporary build artifacts and test configurations
- Not committed to version control (included in .gitignore)
- Used for `sam local start-api` and other local testing commands

### Build Workflow
1. Write and modify TypeScript code in `lib/` and `functions/`
2. Run `npm run build` to compile to JavaScript
3. Compiled files appear in `dist/`
4. For local testing:
   - Run `sam local start-api` to test API endpoints
   - This generates `.aws-sam/` directory
5. Deploy using `cdk deploy`

## Infrastructure Architecture ğŸ¢

### Authentication ğŸ”

- **AWS Cognito** is provisioned with a unified User Pool and multiple app-specific User Groups
- IAM roles restrict access to resources based on the user's group
- JWT tokens are configured for authentication and authorization

### Storage ğŸ“¦

- Separate **S3 buckets** are provisioned for each application with appropriate access policies
- Each application has a dedicated bucket (e.g., `church-storage`, `events-storage`, `student-storage`)
- Lifecycle policies are configured for cost optimization

### Database ğŸ—„ï¸

- Dedicated **NeonDB instances** are provisioned for each application
- Connection strings are stored securely in AWS Parameter Store
- Access is controlled through IAM roles

### API Gateway ğŸŒ‰

- Centralized API Gateway provisions RESTful endpoints
- Routes are organized by domain and protected by appropriate authorization
- Cross-origin resource sharing (CORS) is configured for frontend access

### Monitoring ğŸ“Š

- CloudWatch dashboards track key metrics
- Alarms are configured for important thresholds
- Log retention and filtering policies are applied

## Common Operations ğŸ”„

### Adding a New Application

1. Update `lib/auth-stack.ts` to add new app-specific user group
2. Update `lib/storage-stack.ts` to provision new S3 bucket
3. Update `lib/db-stack.ts` to provision new database
4. Update `lib/api-stack.ts` to add relevant API endpoints
5. Update IAM policies in `lib/iam-stack.ts`

### Handling Infrastructure Changes

1. Make changes to appropriate CDK stack files
2. Run `npm run build` to compile changes
3. Run `cdk diff` to see what will change
4. Run `cdk deploy` to apply changes

### Destroying Infrastructure (Development Only)

```bash
# WARNING: Only use in development environments!
cdk destroy --all

# To destroy specific stacks
cdk destroy ApiStack StorageStack
```

## Useful Commands ğŸ› ï¸

Here are some common commands you'll use during CDK development:

```bash
# Compile TypeScript to JavaScript (generates dist/ directory)
npm run build

# Watch for changes and compile automatically
npm run watch

# Perform Jest unit tests
npm run test

# Deploy stack to your default AWS account/region
npx cdk deploy

# Compare deployed stack with current state
npx cdk diff

# Emit the synthesized CloudFormation template
npx cdk synth
```

## Best Practices ğŸ“

1. **Infrastructure as Code**: Always modify infrastructure through CDK, never manually in the AWS console
2. **Least Privilege**: Follow principle of least privilege when defining IAM roles
3. **Parameterize**: Use CDK context variables and AWS Parameter Store for environment-specific values
4. **Version Control**: Commit CDK changes with descriptive messages explaining the infrastructure changes
5. **Testing**: Test infrastructure changes in development before applying to production
6. **Build Process**: Always run `npm run build` before deploying to ensure latest changes are compiled
7. **Generated Files**: Never commit files from the `dist/` directory to version control

## Troubleshooting ğŸ”

- **CloudFormation Errors**: Check CloudFormation in the AWS Console for detailed error messages
- **CDK Synth Issues**: Ensure TypeScript code compiles correctly with `npm run build`
- **Permission Problems**: Verify IAM permissions for the deploying user
- **API Gateway Errors**: Check CloudWatch Logs for Lambda function errors
- **Build Issues**: If `dist/` files are missing or outdated, run `npm run build` to regenerate them

## API Endpoints for Testing ğŸŒ

### Email Notification Endpoint
```bash
# Send email notification
POST https://api-gateway-url.amazonaws.com/prod/email/send
Content-Type: application/json

{
  "eventId": "your-event-id",
  "recipientEmail": "recipient@example.com"
}
```

### SMS Notification Endpoint
```bash
# Send SMS notification
POST https://api-gateway-url.amazonaws.com/prod/sms/send
Content-Type: application/json

{
  "eventId": "your-event-id",
  "recipientPhone": "+639123456789"
}
```

### Local Testing with SAM CLI
```bash
# Start local API server
sam local start-api

### Email Notification Endpoint
```bash
# Send email notification
POST http://127.0.0.1:3000/email/send
Content-Type: application/json

{
  "eventId": "your-event-id",
  "recipientEmail": "recipient@example.com"
}
```

### SMS Notification Endpoint
```bash
# Send SMS notification
POST http://127.0.0.1:3000/sms/send
Content-Type: application/json

{
  "eventId": "your-event-id",
  "recipientPhone": "+639123456789"
}
```
